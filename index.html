<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Accueil - BECT</title>
<style>
    body { font-family: Arial, sans-serif; padding: 20px; background: #121212; color: #eee; text-align: center; }
    .container { max-width: 600px; margin: 50px auto; background: #1e1e1e; padding: 30px; border-radius: 10px; }
    h1 { margin-bottom: 30px; color: #4caf50; }
    .btn-group { display: flex; flex-direction: column; gap: 15px; }
    .btn { padding: 12px 20px; border-radius: 6px; border: none; font-size: 18px; cursor: pointer; transition: 0.3s; text-decoration: none; font-weight: bold; }
    #btn-logout { background: #f44336; color: white; }
    #btn-logout:hover { background: #d32f2f; }
    .btn-auth { background: #03a9f4; color: white; }
    .btn-auth:hover { background: #0288d1; }
    .btn-publish { background: #ff9800; color: white; }
    .btn-publish:hover { background: #e68900; }
    .username-display { margin-bottom: 20px; font-size: 1.1em; color: #ccc; }
    .status-msg { margin-top: 15px; font-weight: bold; }
</style>
</head>
<body>

<div class="container">
    <h1>Bienvenue sur BECT</h1>
    
    <div id="auth-status" class="username-display"></div>
    
    <div class="btn-group" id="menu-public">
        <a href="connexion.html" class="btn btn-auth">Connexion</a>
        <a href="inscription.html" class="btn btn-auth">Inscription</a>
    </div>
    
    <div class="btn-group" id="menu-prive" style="display:none;">
        <a href="publier.html" class="btn btn-publish">Publier un niveau</a>
        <a href="#" id="btn-logout" class="btn">D√©connexion</a>
    </div>
    
    <p id="status-message" class="status-msg"></p>
</div>

<script type="module">
    const API_URL = "https://bect-project.onrender.com/api";

    const authStatus = document.getElementById('auth-status');
    const menuPublic = document.getElementById('menu-public');
    const menuPrive = document.getElementById('menu-prive');
    const btnLogout = document.getElementById('btn-logout');
    const statusMessage = document.getElementById('status-message');

    // --- Fonction pour d√©connecter l'utilisateur localement ---
    function localLogout(message = "") {
        localStorage.removeItem("bect_user");
        authStatus.textContent = "Non connect√©";
        menuPublic.style.display = 'flex';
        menuPrive.style.display = 'none';
        if (message) {
            statusMessage.textContent = message;
            statusMessage.style.color = '#f44336'; // Rouge pour l'erreur
        }
    }

    // --- V√©rification du statut de l'utilisateur sur le serveur ---
    async function verifyUserStatus() {
        let user = JSON.parse(localStorage.getItem("bect_user"));

        if (!user || !user.token) {
            localLogout("Non connect√©");
            return;
        }

        authStatus.textContent = `V√©rification du compte de ${user.username}...`;
        
        try {
            // Requ√™te vers un endpoint s√©curis√© qui v√©rifie le token (ex: l'endpoint /user du serveur)
            const res = await fetch(`${API_URL}/user`, {
                method: "GET",
                headers: { "Authorization": `Bearer ${user.token}` }
            });

            if (res.ok) {
                // Statut OK (200) : L'utilisateur est toujours l√† et le token est valide.
                const data = await res.json();
                authStatus.textContent = `Connect√© en tant que : ${data.username}`;
                menuPublic.style.display = 'none';
                menuPrive.style.display = 'flex';
                statusMessage.textContent = ""; // Nettoyer le message d'√©tat
            } else if (res.status === 401 || res.status === 404) {
                // Statut 401 (Non autoris√©) ou 404 (Utilisateur non trouv√©)
                localLogout("üõë Vous avez √©t√© d√©connect√©. Votre compte est peut-√™tre banni ou supprim√©. Veuillez r√©essayer la connexion pour confirmer.");
            } else {
                // Autre erreur serveur (500, etc.)
                localLogout("‚ö†Ô∏è Erreur serveur lors de la v√©rification. Veuillez r√©essayer plus tard.");
            }

        } catch (err) {
            console.error("Erreur de v√©rification de statut :", err);
            localLogout("üåê Erreur de connexion r√©seau. Veuillez v√©rifier votre internet.");
        }
    }

    // --- Lancement de la v√©rification au chargement de la page ---
    verifyUserStatus();

    // --- Gestion du bouton D√©connexion ---
    btnLogout.addEventListener('click', (e) => {
        e.preventDefault();
        localLogout("Vous √™tes d√©connect√©.");
        // Facultatif : rediriger vers la page d'accueil ou de connexion apr√®s la d√©connexion si index.html n'est pas la page d'accueil.
        // window.location.href = "index.html"; 
    });
</script>

</body>
</html>