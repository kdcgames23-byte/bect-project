<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>BECT - Accueil</title>
<link rel="stylesheet" href="style.css">
<style>
    /* ------------------------------------------------ */
    /* === ğŸš€ STYLES POUR UN LOOK PLUS PROFESSIONNEL === */
    /* ------------------------------------------------ */

    /* Conteneur principal des rÃ©sultats */
    #search-results {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
        gap: 30px;
        padding: 20px;
    }

    /* Carte de niveau (Level Card) */
    .result-item {
        background: #1e1e1e; /* Gris foncÃ© subtil pour le fond */
        color: #f0f0f0; /* Texte blanc cassÃ© */
        padding: 0; /* On retire le padding ici pour que l'image touche les bords */
        border-radius: 12px;
        overflow: hidden; /* Important pour arrondir les coins de l'image */
        box-shadow: 0 8px 15px rgba(0, 0, 0, 0.5); /* Ombre pro */
        transition: transform 0.2s ease, box-shadow 0.2s ease;
        max-width: 100%; /* S'adapte au grid */
    }

    .result-item:hover {
        transform: translateY(-5px); /* Petit effet de survol */
        box-shadow: 0 12px 20px rgba(0, 0, 0, 0.7);
    }

    /* Conteneur du contenu (Titre, Desc, Bouton) */
    .level-content {
        padding: 15px;
        display: flex;
        flex-direction: column;
        gap: 10px;
    }
    
    .level-content h3 {
        color: #00d0ff; /* Bleu vif pour les titres */
        margin: 0;
        font-size: 1.2em;
        cursor: pointer;
    }

    .level-content p {
        margin: 0;
        font-size: 0.9em;
        color: #b0b0b0;
    }

    .creator-name {
        font-weight: bold;
        color: #4caf50 !important; /* Vert pour le nom du crÃ©ateur */
        cursor: pointer;
    }

    /* Section Diaporama (Image) */
    .slideshow {
        width: 100%;
        height: 200px;
        overflow: hidden;
        position: relative;
    }

    .slideshow img {
        width: 100%;
        height: 200px;
        object-fit: cover;
        position: absolute;
        opacity: 0;
        transition: opacity 0.8s ease-in-out; /* Transition douce pour le dÃ©filement */
    }

    .slideshow img.active {
        opacity: 1;
    }

    /* Bouton de TÃ©lÃ©chargement */
    .download-btn {
        background: #0078ff;
        color: white;
        border: none;
        padding: 10px 15px;
        border-radius: 6px;
        cursor: pointer;
        font-weight: bold;
        letter-spacing: 0.5px;
        transition: background 0.2s ease;
        margin-top: 5px;
    }

    .download-btn:hover {
        background: #0059c9;
    }
</style>
</head>
<body>
<header>
Â  <div id="user-info">
Â  Â  <span id="username-display"></span>
Â  Â  <button id="btn-settings">ParamÃ¨tres</button>
Â  Â  <button id="btn-logout">DÃ©connexion</button>
Â  </div>
Â  <div>
Â  Â  <button id="btn-login">Connexion</button>
Â  Â  <button id="btn-register">Inscription</button>
Â  Â  <button id="btn-publish">Publier</button>
Â  Â  <button id="btn-admin">Admin</button>
Â  </div>
Â  <div>
Â  Â  <input type="text" id="search-input" placeholder="Rechercher un niveau...">
Â  Â  <button id="btn-search">ğŸ”</button>
Â  </div>
</header>

<main>
Â  <div id="search-results"></div>
</main>

<script type="module" src="script.js"></script>
<script type="module">
import { API_URL } from './script.js';

// Stocke tous les niveaux chargÃ©s une seule fois pour la recherche locale
let allLevels = []; 

/**
Â * Charge les niveaux depuis l'API et les filtre localement.
Â * @param {string} searchTerm - Le terme de recherche (facultatif).
Â */
async function loadLevels(searchTerm = "") {
Â  const container = document.getElementById("search-results");
Â  
Â  // Si c'est le premier chargement, on contacte l'API
Â  if (allLevels.length === 0) {
Â  Â  container.innerHTML = "<p>Chargement des niveaux...</p>";
Â  Â  try {
Â  Â  Â  const res = await fetch(`${API_URL}/levels`);
Â  Â  Â  const data = await res.json();
Â  Â  Â  
Â  Â  Â  if (!data.success) {
Â  Â  Â  Â  container.innerHTML = "<p>Erreur lors du chargement des donnÃ©es.</p>";
Â  Â  Â  Â  return;
Â  Â  Â  }
Â  Â  Â  
Â  Â  Â  // Stocke les niveaux pour la recherche locale future
Â  Â  Â  allLevels = data.levels; 
Â  Â  } catch (err) {
Â  Â  Â  console.error(err);
Â  Â  Â  container.innerHTML = "<p>Erreur serveur ou de connexion.</p>";
Â  Â  Â  return;
Â  Â  }
Â  }

Â  // Si aucun niveau n'est chargÃ© aprÃ¨s l'appel API
Â  if (allLevels.length === 0) {
Â  Â  container.innerHTML = "<p>Aucun niveau publiÃ©</p>";
Â  Â  return;
Â  }

Â  // --- FILTRAGE LOCAL DES NIVEAUX ---
Â  const lowerSearchTerm = searchTerm.toLowerCase().trim();
Â  const filteredLevels = allLevels.filter(level => {
Â  Â  if (!lowerSearchTerm) return true; // Si pas de terme, on affiche tout
Â  Â  
Â  Â  // Recherche par titre OU par crÃ©ateur
Â  Â  const matchesTitle = level.title.toLowerCase().includes(lowerSearchTerm);
Â  Â  const matchesCreator = level.creator.toLowerCase().includes(lowerSearchTerm);
Â  Â  
Â  Â  return matchesTitle || matchesCreator;
Â  });
Â  
Â  // --- RENDU DES RÃ‰SULTATS ---
Â  container.innerHTML = "";
Â  
Â  if (filteredLevels.length === 0 && lowerSearchTerm) {
Â  Â  container.innerHTML = `<p>Aucun rÃ©sultat trouvÃ© pour "${searchTerm}".</p>`;
Â  Â  return;
Â  }
Â  
Â  filteredLevels.forEach(level => {
Â  Â  const div = document.createElement("div");
Â  Â  div.classList.add("result-item");

Â  Â  // CrÃ©e le diaporama (Image unique qui dÃ©file si plusieurs images sont dispo)
Â  Â  const slideDiv = document.createElement("div");
Â  Â  slideDiv.classList.add("slideshow");
Â  Â  if (level.images && level.images.length > 0) {
Â  Â  Â  level.images.forEach((imgUrl, index) => {
Â  Â  Â  Â  const img = document.createElement("img");
Â  Â  Â  Â  img.src = imgUrl;
Â  Â  Â  Â  if (index === 0) img.classList.add("active"); // Seule la premiÃ¨re image est visible au dÃ©part
Â  Â  Â  Â  slideDiv.appendChild(img);
Â  Â  Â  });

Â  Â  Â  // Logique de dÃ©filement (Diaporama)
Â  Â  Â  if (level.images.length > 1) {
Â  Â  Â  Â  let current = 0;
Â  Â  Â  Â  setInterval(() => {
Â  Â  Â  Â  Â  const imgs = slideDiv.querySelectorAll("img");
Â  Â  Â  Â  Â  imgs[current].classList.remove("active");
Â  Â  Â  Â  Â  current = (current + 1) % imgs.length;
Â  Â  Â  Â  Â  imgs[current].classList.add("active");
Â  Â  Â  Â  }, 3000);
Â  Â  Â  }
Â  Â  }
Â  Â  div.appendChild(slideDiv); // Ajout du diaporama

Â  Â  // Conteneur pour le texte et le bouton
    const contentDiv = document.createElement("div");
    contentDiv.classList.add("level-content");

Â  Â  const title = document.createElement("h3");
Â  Â  title.textContent = level.title;
Â  Â  title.addEventListener("click", () => {
Â  Â  Â  window.location.href = `niveau.html?id=${encodeURIComponent(level._id)}`;
Â  Â  });

Â  Â  const creator = document.createElement("p");
Â  Â  creator.innerHTML = `CrÃ©Ã© par : <span class="creator-name">${level.creator}</span>`;
Â  Â  creator.querySelector(".creator-name").addEventListener("click", () => {
Â  Â  Â  window.location.href = `utilisateur.html?username=${encodeURIComponent(level.creator)}`;
Â  Â  });

Â  Â  const desc = document.createElement("p");
Â  Â  desc.textContent = level.description || "Aucune description.";

Â  Â  const btnDownload = document.createElement("button");
Â  Â  btnDownload.textContent = "TÃ©lÃ©charger";
Â  Â  btnDownload.classList.add("download-btn");
Â  Â  
Â  Â  // Logique de tÃ©lÃ©chargement
Â  Â  btnDownload.addEventListener("click", async () => {
Â  Â  Â  if (!level.jsonUrl) return alert("Fichier JSON non trouvÃ©.");

Â  Â  Â  try {
Â  Â  Â  Â  const response = await fetch(level.jsonUrl);
Â  Â  Â  Â  if (!response.ok) throw new Error(`Erreur lors du tÃ©lÃ©chargement: ${response.status}`);
Â  Â  Â  Â  
Â  Â  Â  Â  const blob = await response.blob(); 
Â  Â  Â  Â  const url = URL.createObjectURL(blob);
Â  Â  Â  Â  
Â  Â  Â  Â  const a = document.createElement("a");
Â  Â  Â  Â  a.href = url;
Â  Â  Â  Â  a.download = `${level.title}.json`;
Â  Â  Â  Â  document.body.appendChild(a);
Â  Â  Â  Â  a.click();
Â  Â  Â  Â  document.body.removeChild(a);
Â  Â  Â  Â  URL.revokeObjectURL(url);
Â  Â  Â  Â  
Â  Â  Â  } catch(error) {
Â  Â  Â  Â  console.error('Download error:', error);
Â  Â  Â  Â  alert("Erreur lors du tÃ©lÃ©chargement du fichier.");
Â  Â  Â  }
Â  Â  });

    contentDiv.appendChild(title);
    contentDiv.appendChild(creator);
    contentDiv.appendChild(desc);
    contentDiv.appendChild(btnDownload);
    
Â  Â  div.appendChild(contentDiv); // Ajout du contenu textuel
Â  Â  container.appendChild(div);
Â  });
}

// --- GESTION DE LA RECHERCHE ET INITIALISATION ---

const searchInput = document.getElementById("search-input");
const btnSearch = document.getElementById("btn-search");

// 1. Ã‰couteur pour le clic sur le bouton "Recherche"
if (btnSearch) {
Â  btnSearch.addEventListener("click", () => {
Â  Â  loadLevels(searchInput.value);
Â  });
}

// 2. Ã‰couteur pour la touche EntrÃ©e dans le champ de recherche
if (searchInput) {
Â  searchInput.addEventListener("keypress", (e) => {
Â  Â  if (e.key === 'Enter') {
Â  Â  Â  loadLevels(searchInput.value);
Â  Â  }
Â  });
}

// Initialisation au chargement de la page
loadLevels();
</script>
</body>
</html>