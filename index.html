<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>BECT - Accueil</title>
<link rel="stylesheet" href="style.css">
<style>
  .result-item {
    background: #111;
    color: white;
    padding: 10px;
    border-radius: 8px;
    margin-bottom: 15px;
    display: flex;
    flex-direction: column;
    align-items: start;
    gap: 8px;
    max-width: 400px;
  }

  .slideshow {
    width: 100%;
    height: 200px;
    overflow: hidden;
    border-radius: 8px;
    position: relative;
  }

  .slideshow img {
    width: 100%;
    height: 200px;
    object-fit: cover;
    position: absolute;
    transition: opacity 1s ease;
    opacity: 0;
  }

  .slideshow img.active {
    opacity: 1;
  }

  .download-btn {
    background: #0078ff;
    color: white;
    border: none;
    padding: 6px 12px;
    border-radius: 5px;
    cursor: pointer;
  }

  .download-btn:hover {
    background: #0059c9;
  }
</style>
</head>
<body>
<header>
  <div id="user-info">
    <span id="username-display"></span>
    <button id="btn-logout">D√©connexion</button>
  </div>
  <div>
    <button id="btn-login">Connexion</button>
    <button id="btn-register">Inscription</button>
    <button id="btn-publish">Publier</button>
    <button id="btn-admin">Admin</button>
  </div>
  <div>
    <input type="text" id="search-input" placeholder="Rechercher un niveau...">
    <button id="btn-search">üîç</button>
  </div>
</header>

<main>
  <div id="search-results"></div>
</main>

<script type="module" src="script.js"></script>
<script type="module">
import { API_URL } from './script.js';

async function loadLevels() {
  const container = document.getElementById("search-results");
  container.innerHTML = "<p>Chargement...</p>";
  try {
    const res = await fetch(`${API_URL}/levels`);
    const data = await res.json();
    if (!data.success || data.levels.length === 0) {
      container.innerHTML = "<p>Aucun niveau publi√©</p>";
      return;
    }

    container.innerHTML = "";
    data.levels.forEach(level => {
      const div = document.createElement("div");
      div.classList.add("result-item");

      // Cr√©e le diaporama si plusieurs images
      const slideDiv = document.createElement("div");
      slideDiv.classList.add("slideshow");
      if (level.images && level.images.length > 0) {
        level.images.forEach((imgUrl, index) => {
          const img = document.createElement("img");
          img.src = imgUrl;
          if (index === 0) img.classList.add("active");
          slideDiv.appendChild(img);
        });

        if (level.images.length > 1) {
          let current = 0;
          setInterval(() => {
            const imgs = slideDiv.querySelectorAll("img");
            imgs[current].classList.remove("active");
            current = (current + 1) % imgs.length;
            imgs[current].classList.add("active");
          }, 3000);
        }
      }

      const title = document.createElement("h3");
      title.textContent = level.title;
      title.style.cursor = "pointer";
      title.addEventListener("click", () => {
        window.location.href = `niveau.html?id=${encodeURIComponent(level._id)}`;
      });

      const creator = document.createElement("p");
      creator.innerHTML = `Cr√©√© par : <span class="creator-name" style="color:#00d0ff;cursor:pointer;">${level.creator}</span>`;
      creator.querySelector(".creator-name").addEventListener("click", () => {
        window.location.href = `utilisateur.html?username=${encodeURIComponent(level.creator)}`;
      });

      const desc = document.createElement("p");
      desc.textContent = level.description || "Aucune description.";

      const btnDownload = document.createElement("button");
      btnDownload.textContent = "T√©l√©charger";
      btnDownload.classList.add("download-btn");
      btnDownload.addEventListener("click", () => {
        const jsonContent = JSON.stringify(level, null, 2);
        const blob = new Blob([jsonContent], { type: "application/json" });
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = `${level.title}.json`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
      });

      div.appendChild(slideDiv);
      div.appendChild(title);
      div.appendChild(creator);
      div.appendChild(desc);
      div.appendChild(btnDownload);
      container.appendChild(div);
    });
  } catch (err) {
    console.error(err);
    container.innerHTML = "<p>Erreur serveur</p>";
  }
}

loadLevels();
</script>
</body>
</html>
