<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>BECT - Profil</title>
<link rel="stylesheet" href="style.css">
<style>
  .level-card { background: #1e1e1e; padding: 15px; border-radius: 8px; margin-bottom: 15px; border: 1px solid #333; }
  .level-card h3 { margin: 0 0 10px 0; color: #ffa500; cursor: pointer; }
  .btn-group { margin-top: 10px; display: flex; gap: 10px; }
  .btn-dl { background: #4caf50; color: white; border: none; padding: 8px 12px; border-radius: 4px; cursor: pointer; }
  .btn-del { background: #f44336; color: white; border: none; padding: 8px 12px; border-radius: 4px; cursor: pointer; }
</style>
</head>
<body>

<header>
  <button onclick="location.href='index.html'">‚¨Ö Accueil</button>
  <h1 style="margin-left: 20px;">Profil de <span id="profile-name" style="color:#00d0ff;"></span></h1>
</header>

<div style="padding: 20px;">
  <button id="btn-publish-level" style="display:none; margin-bottom: 20px; background:#2196F3; color:white; padding:10px; border:none; border-radius:5px; cursor:pointer;">
    üì§ Publier un nouveau niveau
  </button>
  
  <h2>Niveaux publi√©s :</h2>
  <div id="user-levels">Chargement...</div>
</div>

<script type="module">
import { API_URL, user } from './script.js';

// R√©cup√©ration du nom dans l'URL (ex: ?username=konate)
const urlParams = new URLSearchParams(window.location.search);
const profileUsername = urlParams.get('username');
document.getElementById('profile-name').textContent = profileUsername || "Inconnu";

const btnPublish = document.getElementById('btn-publish-level');
const container = document.getElementById('user-levels');

// Afficher bouton Publier seulement si c'est MON profil
if (user && user.username === profileUsername) {
  btnPublish.style.display = "inline-block";
  btnPublish.onclick = () => window.location.href = 'publier.html';
}

async function fetchLevels() {
  if (!profileUsername) {
    container.innerHTML = "<p>Utilisateur non sp√©cifi√©.</p>";
    return;
  }

  try {
    // APPEL CORRECT √Ä L'API AVEC LE FILTRE
    console.log(`Chargement des niveaux pour : ${profileUsername}`);
    const res = await fetch(`${API_URL}/levels?creator=${encodeURIComponent(profileUsername)}`);
    
    // V√©rification si r√©ponse HTML (le probl√®me que tu avais avant)
    const contentType = res.headers.get("content-type");
    if (contentType && contentType.indexOf("application/json") === -1) {
        throw new Error("Le serveur a renvoy√© du HTML au lieu du JSON (Erreur 404 probable)");
    }

    const data = await res.json();
    
    container.innerHTML = '';
    
    if (!data.success || !data.levels || data.levels.length === 0) {
      container.innerHTML = "<p>Aucun niveau publi√© par cet utilisateur.</p>";
      return;
    }

    // Filtrage de s√©curit√© c√¥t√© client (au cas o√π le serveur renvoie tout)
    const myLevels = data.levels.filter(lvl => lvl.creator === profileUsername);

    if (myLevels.length === 0) {
      container.innerHTML = "<p>Aucun niveau trouv√© pour cet utilisateur.</p>";
      return;
    }

    myLevels.forEach(level => {
      const div = document.createElement('div');
      div.className = "level-card";
      
      let deleteBtnHTML = '';
      // Logique pour le bouton Supprimer
      if (user && (user.username === level.creator || user.role === "admin")) {
        deleteBtnHTML = `<button class="btn-del">Supprimer</button>`;
      }

      div.innerHTML = `
        <h3>${level.title}</h3>
        <p>${level.description || "Pas de description"}</p>
        <div class="btn-group">
          <button class="btn-dl">T√©l√©charger</button>
          ${deleteBtnHTML}
        </div>
      `;

      // Clics
      div.querySelector('h3').onclick = () => window.location.href = `niveau.html?id=${level._id}`;
      div.querySelector('.btn-dl').onclick = () => window.open(level.jsonUrl, '_blank');
      
      const btnDel = div.querySelector('.btn-del');
      if(btnDel){
        btnDel.onclick = async () => {
          if(!confirm("Voulez-vous vraiment supprimer ce niveau ?")) return;
          
          try {
             const r = await fetch(`${API_URL}/levels/${level._id}`, {
               method: "DELETE",
               headers: { "Authorization": `Bearer ${user.token}` }
             });
             const resDel = await r.json();
             
             if(resDel.success) {
               div.remove(); // Suppression visuelle directe
               alert("Niveau supprim√© !");
             } else {
               alert("Erreur: " + resDel.message);
             }
          } catch(err) {
             console.error(err);
             alert("Erreur lors de la suppression");
          }
        };
      }

      container.appendChild(div);
    });

  } catch (e) {
    console.error(e);
    container.innerHTML = `<p style="color:red">Erreur : ${e.message}</p>`;
  }
}

fetchLevels();
</script>
</body>
</html>