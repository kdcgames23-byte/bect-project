<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>BECT - Admin</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>
<header>
  <h1>Admin BECT</h1>
  <button id="logout-btn">Déconnexion</button>
</header>

<main>
  <h2>Liste des utilisateurs</h2>
  <div id="users-container"></div>
</main>

<script>
const user = JSON.parse(localStorage.getItem('bect_user'));
if(!user){ alert('Connectez-vous !'); window.location.href='connexion.html'; }

const API_URL = 'https://bect-project.onrender.com/api';

// Vérifier admin côté frontend (affichage)
if(user.role !== 'admin'){
  // on laisse quand même l'accès si tu fournis ADMIN_KEY dans header ; le backend vérifiera.
}

document.getElementById('logout-btn').addEventListener('click', ()=>{ localStorage.removeItem('bect_user'); window.location.href='connexion.html'; });

async function fetchUsers(){
  try{
    const headers = { 'Authorization': `Bearer ${user.token}` };
    // Si tu veux utiliser ADMIN_KEY côté front, ajoute: headers['admin_key'] = '20090805C0K1D2M98347TA@';

    const res = await fetch(`${API_URL}/admin/users`, { headers });
    const data = await res.json();
    const container = document.getElementById('users-container');
    container.innerHTML = '';

    if(data.success && data.users.length){
      data.users.forEach(u => {
        const div = document.createElement('div');
        div.className = 'user-card';
        div.innerHTML = `
          <span>${u.username}</span>
          <button onclick="deleteUser('${u.username}')">Supprimer</button>
        `;
        container.appendChild(div);
      });
    } else {
      container.innerHTML = "<p>Aucun utilisateur trouvé</p>";
    }
  } catch(e){ console.error(e); alert('Erreur serveur'); }
}

async function deleteUser(username){
  if(!confirm('Supprimer cet utilisateur ?')) return;
  try{
    const headers = { 'Authorization': `Bearer ${user.token}` };
    // headers['admin_key'] = '20090805C0K1D2M98347TA@'; // si tu veux utiliser la clé admin
    const res = await fetch(`${API_URL}/admin/users/${encodeURIComponent(username)}`, { method: 'DELETE', headers });
    const data = await res.json();
    if(data.success){ alert('Utilisateur supprimé !'); fetchUsers(); }
    else alert(data.message);
  } catch(e){ console.error(e); alert('Erreur serveur'); }
}

fetchUsers();
</script>
</body>
</html>