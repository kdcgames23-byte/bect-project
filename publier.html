<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Publier un niveau - BECT</title>
<link rel="stylesheet" href="style.css">
<script type="text/javascript" src="https://cdn.jsdelivr.net/npm/browser-image-compression@2.0.2/dist/browser-image-compression.js"></script>
<style>
Â  body { font-family: Arial, sans-serif; padding: 20px; background: #121212; color: #eee; }
Â  h1 { text-align: center; margin-bottom: 20px; }
Â  form { max-width: 500px; margin: 0 auto; display: flex; flex-direction: column; gap: 12px; background: #1e1e1e; padding: 20px; border-radius: 10px; }
Â  input, textarea, button { padding: 10px; border-radius: 6px; border: none; font-size: 16px; }
Â  input, textarea { background: #2c2c2c; color: #eee; }
Â  button { background: #4caf50; color: white; cursor: pointer; transition: 0.3s; }
Â  button:hover { background: #45a049; }
Â  #msg { text-align: center; margin-top: 10px; font-weight: bold; }
Â  .limit-warning { font-size: 13px; color: #f44336; }
</style>
</head>
<body>

<h1>Publier un niveau</h1>
<p id="username-display" style="text-align:center;margin-bottom:15px;"></p>

<form id="form-publish" onsubmit="return false;">
Â  <input type="text" id="title" placeholder="Titre du niveau (max 10 caractÃ¨res)" required />
Â  <p id="title-warning" class="limit-warning"></p>

Â  <textarea id="description" placeholder="Description du niveau (max 100 caractÃ¨res)" rows="4"></textarea>
Â  <p id="desc-warning" class="limit-warning"></p>

Â  <label>Fichier JSON du niveau :</label>
Â  <input type="file" id="jsonFile" accept=".json" required />

Â  <label>Image 1 (Miniature) :</label>
Â  <input type="file" id="image1" accept="image/*" />
Â  <label>Image 2 :</label>
Â  <input type="file" id="image2" accept="image/*" />
Â  <label>Image 3 :</label>
Â  <input type="file" id="image3" accept="image/*" />

Â  <button id="btn-publish-level" type="button">Publier</button>
Â  <p id="msg"></p>
</form>

<script type="module">
const API_URL = "https://bect-project.onrender.com/api";
const MIN_SIZE_TO_COMPRESS_MB = 1; // DÃ©clenchement de la compression Ã  partir de 1 Mo
const TARGET_SIZE_MB = 0.7; Â  Â  Â  // Cible de compression : 0.7 Mo

let user = JSON.parse(localStorage.getItem("bect_user"));

const usernameDisplay = document.getElementById("username-display");
if(user){
Â  usernameDisplay.textContent = `ConnectÃ© en tant que : ${user.username}`;
} else {
Â  alert("Vous devez Ãªtre connectÃ© pour publier !");
Â  window.location.href = "connexion.html";
}

const btn = document.getElementById('btn-publish-level');
const msg = document.getElementById('msg');

// Ã‰lÃ©ments de saisie
const titleInput = document.getElementById("title");
const descInput = document.getElementById("description");
const titleWarn = document.getElementById("title-warning");
const descWarn = document.getElementById("desc-warning");

// Gestion des limites de caractÃ¨res
titleInput.addEventListener("input", () => {
Â  if (titleInput.value.length > 10) {
Â  Â  titleWarn.textContent = "Le titre ne doit pas dÃ©passer 10 caractÃ¨res.";
Â  Â  titleInput.value = titleInput.value.slice(0, 10);
Â  } else {
Â  Â  titleWarn.textContent = "";
Â  }
});

descInput.addEventListener("input", () => {
Â  if (descInput.value.length > 100) {
Â  Â  descWarn.textContent = "La description ne doit pas dÃ©passer 100 caractÃ¨res.";
Â  Â  descInput.value = descInput.value.slice(0, 100);
Â  } else {
Â  Â  descWarn.textContent = "";
Â  }
});

// === Fonction de vÃ©rification des mots interdits (InchagnÃ©e) ===
function checkForbiddenWords(text) {
Â  Â  const forbiddenWords = ["pute","connard","sexe","viols","porn","nu","enculÃ©","viol","bais","seins","couilles","cul","salope","sodomie","baiser","branler","pÃ©nis","vagin","nichon","clitoris","sperme","Ã©jaculation","fellatio","cuni","masturber","coÃ¯t","inceste","pÃ©dophilie","zoophilie","drogue","cocaÃ¯ne","hÃ©roÃ¯ne","crack","cannabis","meurtre","tuer","raciste","nÃ¨gre","juif","arabe","gouine","pd","sale","merde","gros mot","niquer","chier","tabarnak","hostie","milf","nudes","fuck","dick","pussy","ass","tits","cunt","whore","slut","cock","vagina","penis","nsfw","sex","rape","anal","bdsm","faggot","gay","lesbian","weed","coke","heroin","shit","kill","murder","nigger","kike","pornography","blowjob","jizz","cumshot","gangbang","incest","child abuse","pedo","zoophile","groping","molest","bitch","douchebag","goddamn","asshole","puta","joder","coÃ±o","culo","pene","vagina","mierda","cabrÃ³n","chingar","teta","pollas","gilipollas","maricÃ³n","violar","follar","cazzo","figa","puttana","troia","merda","stronzo","frocio","scopare","vaffanculo","coglione","sesso","violenza","fotze","wichser","arschloch","schwanz","muschi","ficken","scheiÃŸe","vergewaltigung","hure","nutte","titten","schwul","puta","caralho","fodase","pica","cu","bosta","violar","foder","buceta","porra","chupar","vagabunda","nsfw","milf","bdsm","hentai","sexo","guro","snuff","gore","lolicon","shota","drugs","4chan","gore","loli"];
Â  Â  const normalizedText = text.toLowerCase().replace(/[.,\/#!$%\^&\*;:{}=\-_`~()]/g,"");
Â  Â  const words = normalizedText.split(/\s+/).filter(word => word.length > 2);
Â  Â  for (const word of words) {
Â  Â  Â  Â  if (forbiddenWords.includes(word)) {
Â  Â  Â  Â  Â  Â  return word;
Â  Â  Â  Â  }
Â  Â  }
Â  Â  return null;
}

// === ðŸš€ FONCTION DE COMPRESSION D'IMAGE (Mise Ã  jour) ===
async function compressImageIfNeeded(file) {
Â  Â  if (!file) return { file: null, compressed: false };
Â  Â  
Â  Â  // VÃ©rifie si l'image dÃ©passe la taille MIN_SIZE_TO_COMPRESS_MB (1 Mo)
Â  Â  if (file.size > MIN_SIZE_TO_COMPRESS_MB * 1024 * 1024) {
Â  Â  Â  Â  
Â  Â  Â  Â  const options = {
Â  Â  Â  Â  Â  Â  maxSizeMB: TARGET_SIZE_MB, Â  Â  // Nouvelle cible : 0.7 Mo
Â  Â  Â  Â  Â  Â  maxWidthOrHeight: 1920, Â  Â  Â  
Â  Â  Â  Â  Â  Â  useWebWorker: true
Â  Â  Â  Â  };

Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  const compressedFile = await imageCompression(file, options);
Â  Â  Â  Â  Â  Â  return { file: compressedFile, compressed: true, originalSize: file.size }; // Ajout du statut de compression
Â  Â  Â  Â  } catch (error) {
Â  Â  Â  Â  Â  Â  console.error("Erreur lors de la compression :", error);
Â  Â  Â  Â  Â  Â  return { file: file, compressed: false, originalSize: file.size }; 
Â  Â  Â  Â  }
Â  Â  }
Â  Â  
Â  Â  // Si l'image fait moins de 1 Mo
Â  Â  return { file: file, compressed: false, originalSize: file.size };
}

// === Envoi du formulaire (Mise Ã  jour pour le feedback) ===
btn.addEventListener('click', async ()=>{
Â  let title = titleInput.value.trim();
Â  let description = descInput.value.trim();
Â  const jsonFile = document.getElementById("jsonFile").files[0];
Â  
Â  // RÃ©cupÃ©ration des fichiers bruts
Â  const rawImg1 = document.getElementById("image1").files[0];
Â  const rawImg2 = document.getElementById("image2").files[0];
Â  const rawImg3 = document.getElementById("image3").files[0];

Â  // --- VÃ‰RIFICATIONS BASIQUES (InchagnÃ©es) ---
Â  if(!title || !jsonFile){
Â  Â  msg.style.color = "#f44336";
Â  Â  msg.textContent = "Veuillez fournir un titre et un fichier JSON.";
Â  Â  return;
Â  }
Â  if(!rawImg1 && !rawImg2 && !rawImg3){
Â  Â  msg.style.color = "#f44336";
Â  Â  msg.textContent = "Vous devez ajouter au moins une image.";
Â  Â  return;
Â  }
Â  if (title.length > 10 || description.length > 100) {
Â  Â  msg.style.color = "#f44336";
Â  Â  msg.textContent = "Erreur de taille (titre max 10, description max 100).";
Â  Â  return;
Â  }

Â  // --- VÃ‰RIFICATION MOTS INTERDITS (InchagnÃ©e) ---
Â  const forbiddenTitle = checkForbiddenWords(title);
Â  const forbiddenDesc = checkForbiddenWords(description);

Â  if (forbiddenTitle) {
Â  Â  Â  msg.style.color = "#f44336";
Â  Â  Â  msg.textContent = `Titre refusÃ© : Le mot "${forbiddenTitle}" n'est pas autorisÃ©.`;
Â  Â  Â  return;
Â  }
Â  
Â  if (forbiddenDesc) {
Â  Â  Â  msg.style.color = "#f44336";
Â  Â  Â  msg.textContent = `Description refusÃ©e : Le mot "${forbiddenDesc}" n'est pas autorisÃ©.`;
Â  Â  Â  return;
Â  }

Â  // --- COMPRESSION DES IMAGES (Si nÃ©cessaire) ---
Â  msg.style.color = "#ffa500"; 
Â  msg.textContent = "Analyse des images et compression (si > 1Mo) en cours...";
Â  btn.disabled = true; // DÃ©sactiver le bouton pendant le traitement

Â  let compressionOccurred = false;

Â  // On compresse les images une par une et on rÃ©cupÃ¨re le rÃ©sultat
Â  const result1 = await compressImageIfNeeded(rawImg1);
Â  const result2 = await compressImageIfNeeded(rawImg2);
Â  const result3 = await compressImageIfNeeded(rawImg3);
Â  
Â  if (result1.compressed || result2.compressed || result3.compressed) {
Â  Â  Â  compressionOccurred = true;
Â  }

Â  // --- CRÃ‰ATION DU FORM DATA ---
Â  const formData = new FormData();
Â  formData.append("title", title);
Â  formData.append("description", description);
Â  formData.append("jsonFile", jsonFile);
Â  if(result1.file) formData.append("image1", result1.file);
Â  if(result2.file) formData.append("image2", result2.file);
Â  if(result3.file) formData.append("image3", result3.file);

Â  // --- MESSAGE DE CONFIRMATION AVANT L'ENVOI ---
Â  if (compressionOccurred) {
Â  Â  Â  msg.textContent = "âœ… Images compressÃ©es Ã  0.7 Mo max. Envoi des donnÃ©es...";
Â  Â  Â  msg.style.color = "#4caf50";
Â  } else {
Â  Â  Â  msg.textContent = "Envoi des donnÃ©es au serveur...";
Â  Â  Â  msg.style.color = "#fff";
Â  }
Â  

Â  try{
Â  Â  const res = await fetch(`${API_URL}/publish`, {
Â  Â  Â  method: "POST",
Â  Â  Â  headers: { "Authorization": `Bearer ${user.token}` },
Â  Â  Â  body: formData
Â  Â  });
Â  Â  const data = await res.json();
Â  Â  btn.disabled = false; // RÃ©activer le bouton aprÃ¨s la tentative d'envoi

Â  Â  if(data.success){
Â  Â  Â  msg.style.color = "#4caf50";
Â  Â  Â  msg.textContent = "Niveau publiÃ© avec succÃ¨s !";
Â  Â  Â  document.getElementById('form-publish').reset();
Â  Â  Â  titleWarn.textContent = "";
Â  Â  Â  descWarn.textContent = "";
Â  Â  } else {
Â  Â  Â  msg.style.color = "#f44336";
Â  Â  Â  msg.textContent = data.message || "Erreur lors de la publication";
Â  Â  }
Â  } catch(err){
Â  Â  console.error(err);
Â  Â  msg.style.color = "#f44336";
Â  Â  msg.textContent = "Erreur serveur";
Â  Â  btn.disabled = false; // RÃ©activer en cas d'erreur
Â  }
});
</script>

</body>
</html>