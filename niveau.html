<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>BECT - Niveau</title>
<link rel="stylesheet" href="style.css">
</head>
<body>
<header>
  <div id="user-info" style="display:none;">
    <span id="username-display" style="cursor:pointer;"></span>
    <button id="btn-logout">D√©connexion</button>
  </div>
  <div>
    <button id="btn-login">Connexion</button>
    <button id="btn-register">Inscription</button>
    <button id="btn-publish" style="display:none;">Publier</button>
    <button id="btn-admin" style="display:none;">Admin</button>
  </div>
</header>

<main>
  <div id="level-container">
    <h1 id="level-title"></h1>
    <p id="level-creator"></p>
    <p id="level-description"></p>
    <div id="level-images"></div>
    <button id="btn-download-json">T√©l√©charger JSON</button>
  </div>
</main>

<script type="module" src="script.js"></script>
<script type="module">
import { API_URL } from './script.js';

async function loadLevel() {
  const params = new URLSearchParams(window.location.search);
  const id = params.get("id");
  if(!id) return alert("Niveau introuvable");

  try {
    // Note: Pour une meilleure efficacit√©, vous devriez utiliser la route /api/levels/:id
    const res = await fetch(`${API_URL}/levels`); 
    const data = await res.json();
    if(!data.success) return alert("Erreur serveur");

    const level = data.levels.find(l => l._id === id);
    if(!level) return alert("Niveau introuvable");

    document.getElementById("level-title").textContent = level.title;
    
    const creatorP = document.getElementById("level-creator");
    creatorP.innerHTML = `Cr√©√© par : <span class="creator-name" style="color:#00d0ff;cursor:pointer;">${level.creator}</span>`;
    creatorP.querySelector(".creator-name").addEventListener("click", () => {
        window.location.href = `utilisateur.html?username=${encodeURIComponent(level.creator)}`;
    });
    
    document.getElementById("level-description").textContent = level.description || "";

    const imagesContainer = document.getElementById("level-images");
    imagesContainer.innerHTML = "";
    (level.images || []).forEach(url=>{
      const img = document.createElement("img");
      img.src = url;
      img.style.width = "200px";
      img.style.height = "150px";
      img.style.objectFit = "cover";
      img.style.marginRight = "10px";
      img.onerror = ()=> img.src="https://via.placeholder.com/200x150?text=Image";
      imagesContainer.appendChild(img);
    });

    // üö© CORRECTION : Utilisation de fetch pour garantir que le fichier soit un blob local avant de le t√©l√©charger avec l'extension .json
    document.getElementById("btn-download-json").onclick = async ()=>{
      if (!level.jsonUrl) return alert("Fichier JSON non trouv√©.");

      try {
        const response = await fetch(level.jsonUrl);
        if (!response.ok) throw new Error(`Erreur lors du t√©l√©chargement: ${response.status}`);
          
        const blob = await response.blob(); 
        const url = URL.createObjectURL(blob);
          
        const a = document.createElement("a");
        a.href = url;
        a.download = `${level.title}.json`; // <-- Cible de la correction : Garantit l'extension .json
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
          
      } catch(error) {
        console.error('Download error:', error);
        alert("Erreur lors du t√©l√©chargement du fichier.");
      }
    }

  } catch(err) {
    console.error(err);
    alert("Erreur chargement du niveau");
  }
}

loadLevel();
</script>
</body>
</html>