import e from"express";import s from"cors";import a from"dotenv";import r from"mongoose";import t from"jsonwebtoken";import o from"bcryptjs";import n from"cloudinary";import i from"multer";import u from"path";import{fileURLToPath as c}from"url";a.config();let __filename=c(import.meta.url),__dirname=u.dirname(__filename),app=e(),apiRouter=e.Router();app.use(s()),app.use(e.json({limit:"10mb"})),n.v2.config({cloud_name:process.env.CLOUDINARY_CLOUD_NAME,api_key:process.env.CLOUDINARY_API_KEY,api_secret:process.env.CLOUDINARY_API_SECRET}),r.connect(process.env.MONGO_URI).then(()=>console.log("✅ MongoDB Connect\xe9")).catch(e=>console.error("❌ Erreur Mongo:",e));let userSchema=new r.Schema({username:{type:String,unique:!0},password:String,role:{type:String,default:"user"}}),levelSchema=new r.Schema({creator:String,title:String,description:String,images:[String],jsonUrl:String,createdAt:{type:Date,default:Date.now}}),User=r.model("User",userSchema),Level=r.model("Level",levelSchema);function auth(e,s,a){let r=e.headers.authorization?.split(" ")[1];if(console.log(`[AUTH] Checking path: ${e.path}. Token present: ${!!r}`),!r)return s.status(401).json({success:!1,message:"Token manquant"});try{e.user=t.verify(r,process.env.JWT_SECRET),a()}catch(o){return console.error(`[AUTH] Token verification failed: ${o.message}`),s.status(401).json({success:!1,message:"Token invalide"})}}let storage=i.memoryStorage(),upload=i({storage});function uploadToCloudinary(e,s="auto"){return new Promise((a,r)=>{n.v2.uploader.upload_stream({resource_type:s},(e,s)=>{if(e)return r(e);a(s.secure_url)}).end(e)})}async function deleteCloudinaryFiles(e){try{if(e.images)for(let s of e.images){let a=s.split("/").pop().split(".")[0];await n.v2.uploader.destroy(a)}if(e.jsonUrl){let r=e.jsonUrl.split("/").pop().split(".")[0];await n.v2.uploader.destroy(r,{resource_type:"raw"})}}catch(t){console.error("Erreur nettoyage:",t)}}apiRouter.post("/register",async(e,s)=>{try{let{username:a,password:r}=e.body;if(await User.findOne({username:a}))return s.json({success:!1,message:"Pseudo pris"});let t=await o.hash(r,10);await new User({username:a,password:t}).save(),s.json({success:!0,message:"Compte cr\xe9\xe9"})}catch(n){s.status(500).json({success:!1,error:n.message})}}),apiRouter.post("/login",async(e,s)=>{try{let{username:a,password:r}=e.body,n=await User.findOne({username:a});if(!n||!await o.compare(r,n.password))return s.json({success:!1,message:"Erreur identifiants"});let i=t.sign({id:n._id,username:n.username,role:n.role},process.env.JWT_SECRET,{expiresIn:"30d"});s.json({success:!0,token:i,username:n.username,role:n.role})}catch(u){s.status(500).json({success:!1})}}),apiRouter.post("/become-admin",auth,async(e,s)=>{let{key:a}=e.body,r=process.env.ADMIN_KEY;if(a!==r)return s.status(403).json({success:!1,message:"Cl\xe9 incorrecte"});let o=await User.findOneAndUpdate({username:e.user.username},{role:"admin"},{new:!0}),n=t.sign({id:o._id,username:o.username,role:"admin"},process.env.JWT_SECRET,{expiresIn:"30d"});s.json({success:!0,token:n,role:"admin"})}),apiRouter.put("/user/username",auth,async(e,s)=>{try{let{newUsername:a,password:r}=e.body;if(await User.findOne({username:a}))return s.status(400).json({success:!1,message:"Ce nom d'utilisateur est d\xe9j\xe0 utilis\xe9."});let n=await User.findById(e.user.id);if(!n||!await o.compare(r,n.password))return s.status(401).json({success:!1,message:"Mot de passe actuel incorrect."});let i=n.username;n.username=a,await n.save(),await Level.updateMany({creator:i},{$set:{creator:a}});let u=t.sign({id:n._id,username:n.username,role:n.role},process.env.JWT_SECRET,{expiresIn:"30d"});s.json({success:!0,message:"Nom d'utilisateur mis \xe0 jour",token:u})}catch(c){console.error("Erreur mise \xe0 jour username:",c),s.status(500).json({success:!1,message:"Erreur serveur interne."})}}),apiRouter.put("/user/password",auth,async(e,s)=>{try{let{currentPassword:a,newPassword:r}=e.body,t=await User.findById(e.user.id);if(!t||!await o.compare(a,t.password))return s.status(401).json({success:!1,message:"Mot de passe actuel incorrect."});let n=await o.hash(r,10);t.password=n,await t.save(),s.json({success:!0,message:"Mot de passe mis \xe0 jour."})}catch(i){console.error("Erreur mise \xe0 jour mot de passe:",i),s.status(500).json({success:!1,message:"Erreur serveur interne."})}}),apiRouter.post("/publish",auth,upload.fields([{name:"jsonFile",maxCount:1},{name:"image1",maxCount:1},{name:"image2",maxCount:1},{name:"image3",maxCount:1}]),async(e,s)=>{try{let{title:a,description:r}=e.body,t=await uploadToCloudinary(e.files.jsonFile[0].buffer,"raw"),o=[];e.files.image1&&o.push(await uploadToCloudinary(e.files.image1[0].buffer)),e.files.image2&&o.push(await uploadToCloudinary(e.files.image2[0].buffer)),e.files.image3&&o.push(await uploadToCloudinary(e.files.image3[0].buffer));let n=await new Level({creator:e.user.username,title:a,description:r,images:o,jsonUrl:t}).save();s.json({success:!0,id:n._id})}catch(i){s.status(500).json({success:!1})}}),apiRouter.get("/levels",async(e,s)=>{try{let a={};e.query.creator&&(a.creator=e.query.creator);let r=await Level.find(a).sort({createdAt:-1});s.json({success:!0,levels:r})}catch(t){s.status(500).json({success:!1,message:"Erreur serveur"})}}),apiRouter.get("/levels/:id",async(e,s)=>{try{let a=await Level.findById(e.params.id);if(!a)return s.status(404).json({success:!1});s.json({success:!0,level:a})}catch{s.status(404).json({success:!1})}}),apiRouter.delete("/levels/:id",auth,async(e,s)=>{try{let a=await Level.findById(e.params.id);if(!a)return s.status(404).json({success:!1,message:"Niveau introuvable"});if(a.creator!==e.user.username&&"admin"!==e.user.role)return s.status(403).json({success:!1,message:"Interdit"});await deleteCloudinaryFiles(a),await Level.deleteOne({_id:a._id}),s.json({success:!0,message:"Suppression r\xe9ussie"})}catch(r){s.status(500).json({success:!1,message:"Erreur interne"})}}),apiRouter.get("/search",async(e,s)=>{let a=e.query.query;if(!a)return s.json([]);let r=await Level.find({$or:[{title:{$regex:a,$options:"i"}},{creator:{$regex:a,$options:"i"}}]}).limit(20);s.json(r)}),apiRouter.get("/admin/users",auth,async(e,s)=>{if("admin"!==e.user.role)return s.status(403).json({success:!1});let a=await User.find({},"username role");s.json({success:!0,users:a})}),apiRouter.get("/admin/levels",auth,async(e,s)=>{if("admin"!==e.user.role)return s.status(403).json({success:!1});let a=await Level.find({});s.json({success:!0,levels:a})}),apiRouter.delete("/admin/users/:username",auth,async(e,s)=>{if("admin"!==e.user.role)return s.status(403).json({success:!1});let a=e.params.username,r=await Level.find({creator:a});for(let t of r)await deleteCloudinaryFiles(t);await Level.deleteMany({creator:a}),await User.deleteOne({username:a}),s.json({success:!0})});let projectRoot=u.resolve(__dirname,"..");app.use("/api",apiRouter),app.use(e.static(projectRoot)),app.get("*",(e,s)=>{s.sendFile(u.join(projectRoot,"index.html"))});let PORT=process.env.PORT||3e3;app.listen(PORT,()=>console.log(`✅ SERVEUR LANC\xc9 SUR PORT ${PORT}`));